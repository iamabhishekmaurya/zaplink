STEP 1:

CREATE TABLE url_mappings (
    id BIGSERIAL PRIMARY KEY,
    short_url_key VARCHAR(255) UNIQUE NOT NULL,
    original_url TEXT NOT NULL,
    short_url VARCHAR(500) NOT NULL,
    trace_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,
    click_count BIGINT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'ACTIVE'
);

STEP 2:

CREATE INDEX idx_short_url_key ON url_mappings(short_url_key);
CREATE INDEX idx_created_at ON url_mappings(created_at);
CREATE INDEX idx_status ON url_mappings(status);

STEP 3:

CREATE TABLE url_analytics (
    id BIGSERIAL PRIMARY KEY,
    short_url_key VARCHAR(255) NOT NULL,
    ip_address INET,
    user_agent TEXT,
    referrer VARCHAR(500),
    country VARCHAR(100),
    city VARCHAR(100),
    accessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (short_url_key) REFERENCES url_mappings(short_url_key)
);

STEP 4:

CREATE INDEX idx_short_url_key_analytics ON url_analytics(short_url_key);
CREATE INDEX idx_accessed_at ON url_analytics(accessed_at);

STEP 5:

CREATE TABLE url_statistics (
    id BIGSERIAL PRIMARY KEY,
    short_url_key VARCHAR(255) UNIQUE NOT NULL,
    total_clicks BIGINT DEFAULT 0,
    today_clicks BIGINT DEFAULT 0,
    last_accessed TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (short_url_key) REFERENCES url_mappings(short_url_key)
);

STEP 6:

CREATE INDEX idx_total_clicks ON url_statistics(total_clicks);
CREATE INDEX idx_last_accessed ON url_statistics(last_accessed);


--------------------------------------------------------------------------------------

CREATE TABLE public.login_attempts (
	id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
	created_at timestamp(6) NOT NULL,
	email varchar(255) NOT NULL,
	failure_reason varchar(255) NULL,
	ip_address varchar(255) NULL,
	successful bool NOT NULL,
	user_agent varchar(255) NULL,
	CONSTRAINT login_attempts_pkey PRIMARY KEY (id)
);

CREATE TABLE public.refresh_tokens (
	id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
	created_at timestamptz(6) NOT NULL,
	expiry_date timestamptz(6) NOT NULL,
	"token" varchar(255) NOT NULL,
	user_id int8 NOT NULL,
	CONSTRAINT refresh_tokens_pkey PRIMARY KEY (id)
);

CREATE TABLE public.roles (
	id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
	description varchar(200) NULL,
	"name" varchar(50) NOT NULL,
	CONSTRAINT roles_pkey PRIMARY KEY (id),
	CONSTRAINT ukofx66keruapi6vyqpv6f2or37 UNIQUE (name)
);

CREATE TABLE public.users (
	id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
	is_active bool NULL,
	created_at timestamptz(6) NOT NULL,
	email varchar(255) NOT NULL,
	first_name varchar(50) NULL,
	last_name varchar(50) NULL,
	"password" varchar(100) NOT NULL,
	phone_number varchar(20) NULL,
	reset_token varchar(255) NULL,
	reset_token_expiry timestamptz(6) NULL,
	updated_at timestamptz(6) NULL,
	username varchar(50) NOT NULL,
	verification_token varchar(255) NULL,
	is_verified bool NULL,
	CONSTRAINT uk6dotkott2kjsp8vw4d0m25fb7 UNIQUE (email),
	CONSTRAINT ukr43af9ap4edm43mmtq01oddj6 UNIQUE (username),
	CONSTRAINT users_pkey PRIMARY KEY (id)
);

CREATE TABLE public.user_roles (
	user_id int8 NOT NULL,
	role_id int8 NOT NULL,
	CONSTRAINT user_roles_pkey PRIMARY KEY (user_id, role_id)
);


-- public.user_roles foreign keys

ALTER TABLE public.user_roles ADD CONSTRAINT fkh8ciramu9cc9q3qcqiv4ue8a6 FOREIGN KEY (role_id) REFERENCES public.roles(id);
ALTER TABLE public.user_roles ADD CONSTRAINT fkhfh9dx7w3ubf1co1vdev94g3f FOREIGN KEY (user_id) REFERENCES public.users(id);